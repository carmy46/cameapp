<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Ore - CAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- XLSX Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/effects.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar (same as dashboard) -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#0066FF;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#8B5CF6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00D9B1;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="24" cy="24" r="22" fill="url(#logoGradient)"/>
                        <path d="M18 16C21.866 16 25 19.134 25 23C25 26.866 21.866 30 18 30"
                              stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                        <path d="M29 30L33 16L37 30"
                              stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <path d="M31 26H35" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="logo-text">CAME</div>
            </div>

            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principale</div>
                    <a href="employee-dashboard.html" class="nav-item">
                        <i data-lucide="home" class="nav-item-icon"></i>
                        <span class="sidebar-label">Dashboard</span>
                    </a>
                    <a href="timesheet.html" class="nav-item active">
                        <i data-lucide="clock" class="nav-item-icon"></i>
                        <span class="sidebar-label">Ore di Lavoro</span>
                    </a>
                    <a href="time-registration.html" class="nav-item">
                        <i data-lucide="plus-circle" class="nav-item-icon"></i>
                        <span class="sidebar-label">Registrazione Ore</span>
                    </a>
                    <a href="requests.html" class="nav-item">
                        <i data-lucide="calendar-check" class="nav-item-icon"></i>
                        <span class="sidebar-label">Richieste</span>
                    </a>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="nav-item w-full" onclick="window.Auth.logout()" style="border: none; background: none; text-align: left;">
                    <i data-lucide="log-out" class="nav-item-icon"></i>
                    <span class="sidebar-label">Esci</span>
                </button>
            </div>

            <button class="sidebar-toggle" aria-label="Chiudi menu laterale">
                <i data-lucide="chevron-left"></i>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" data-sidebar-toggle aria-label="Apri menu laterale">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Gestione Ore</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-outline btn-sm" onclick="window.Auth.logout()" title="Esci dall'applicazione">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                    </button>

                    <button class="btn btn-primary" onclick="exportTimesheet()">
                        <i data-lucide="download"></i>
                        Esporta Excel
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="page-content">

                <!-- History -->
                <div class="card mt-6 card-text-dark">
                    <div class="card-header">
                        <h3 class="card-title">Storico Registrazioni Inviate</h3>
                        <p class="card-subtitle">Visualizza le registrazioni archiviate per mese</p>
                    </div>

                    <!-- Month and Search Filter -->
                    <div class="card-body" style="padding: 16px 24px; border-bottom: 1px solid rgba(203, 213, 225, 0.3);">
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <label style="font-size: 0.875rem; color: #6b7280; white-space: nowrap;">
                                    <i data-lucide="calendar" style="width: 16px; height: 16px; display: inline; vertical-align: middle;"></i>
                                    Mese:
                                </label>
                                <select id="monthFilter" class="btn btn-outline" style="padding: 8px 12px; font-size: 0.875rem; min-width: 180px;" onchange="changeMonth()">
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="relative" style="flex: 1;">
                                <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #6b7280;"></i>
                                <input type="text" id="searchHistory" placeholder="Cerca per data, luogo, attività..."
                                       style="width: 100%; padding: 10px 10px 10px 40px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem;"
                                       oninput="filterHistory()">
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Luogo</th>
                                    <th>Attività</th>
                                    <th>Orario</th>
                                    <th>Ore Totali</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Info Footer -->
                    <div class="card-body" style="padding: 16px 24px; border-top: 1px solid rgba(203, 213, 225, 0.3);">
                        <div style="font-size: 0.875rem; color: #6b7280; text-align: center;">
                            <span id="totalRecords">0</span> registrazioni trovate
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/data.js"></script>

    <script>
        // Check auth
        const currentUser = window.Auth.getCurrentUser();
        if (!currentUser || currentUser.role !== 'employee') {
            console.log('Access denied: Employee role required for timesheet');
            localStorage.removeItem('came_session');
            window.location.replace('index.html');
        }

        let allUserRegistrations = [];
        let availableMonths = [];
        let currentMonth = '';

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadHistory();
        });

        async function loadHistory() {
            // Mostra skeleton durante caricamento
            window.UI.showTableSkeleton('#historyTable', 5, 6);

            // Carica le registrazioni ore da Firestore (collezione centralizzata)
            const allTimeRegs = await window.Storage.getAllTimeRegistrations();

            // Filtra solo le registrazioni dell'utente corrente
            allUserRegistrations = allTimeRegs.filter(reg => reg.userId === currentUser.id);

            // Ordina per data decrescente (più recenti prima)
            allUserRegistrations.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Estrai i mesi disponibili
            extractAvailableMonths();

            // Popola il select dei mesi
            populateMonthSelector();

            // Rendi la tabella
            renderHistory();
        }

        function extractAvailableMonths() {
            const monthsSet = new Set();

            allUserRegistrations.forEach(reg => {
                const date = new Date(reg.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthsSet.add(monthKey);
            });

            // Converti in array e ordina (più recente prima)
            availableMonths = Array.from(monthsSet).sort().reverse();

            // Imposta il mese corrente come default (il più recente)
            currentMonth = availableMonths[0] || '';
        }

        function populateMonthSelector() {
            const select = document.getElementById('monthFilter');

            if (availableMonths.length === 0) {
                select.innerHTML = '<option value="">Nessun mese disponibile</option>';
                return;
            }

            select.innerHTML = availableMonths.map(monthKey => {
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1, 1);
                const monthName = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                const capitalizedMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);

                return `<option value="${monthKey}" ${monthKey === currentMonth ? 'selected' : ''}>${capitalizedMonth}</option>`;
            }).join('');
        }

        function filterByMonth(registrations, monthKey) {
            if (!monthKey) return registrations;

            const [year, month] = monthKey.split('-');

            return registrations.filter(reg => {
                const regDate = new Date(reg.date);
                const regMonthKey = `${regDate.getFullYear()}-${String(regDate.getMonth() + 1).padStart(2, '0')}`;
                return regMonthKey === monthKey;
            });
        }

        function renderHistory() {
            const tbody = document.getElementById('historyTable');
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase().trim();

            // Applica filtro mese
            let filtered = filterByMonth(allUserRegistrations, currentMonth);

            // Applica filtro ricerca
            if (searchTerm) {
                filtered = filtered.filter(entry => {
                    const date = window.UI.formatDate(entry.date).toLowerCase();
                    const location = (entry.location || '').toLowerCase();
                    const activity = (entry.activity || '').toLowerCase();
                    const orario = `${entry.startTime || ''} - ${entry.endTime || ''}`.toLowerCase();

                    return date.includes(searchTerm) ||
                           location.includes(searchTerm) ||
                           activity.includes(searchTerm) ||
                           orario.includes(searchTerm);
                });
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-neutral-500">Nessuna registrazione trovata per questo mese</td></tr>';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }

            tbody.innerHTML = filtered.map(entry => `
                <tr>
                    <td>${window.UI.formatDate(entry.date)}</td>
                    <td>${entry.location || '-'}</td>
                    <td>${entry.activity || '-'}</td>
                    <td>${entry.startTime || '-'} - ${entry.endTime || '-'}</td>
                    <td class="font-medium">${entry.totalHours || '-'}</td>
                    <td><span class="badge badge-success">Inviato</span></td>
                </tr>
            `).join('');

            document.getElementById('totalRecords').textContent = filtered.length;
            lucide.createIcons();
        }

        function changeMonth() {
            currentMonth = document.getElementById('monthFilter').value;
            renderHistory();
        }

        function filterHistory() {
            renderHistory();
        }

        async function exportTimesheet() {
            // Funzione helper per formattare la data
            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Prepara i dati per Excel
            const headers = ['Data', 'Luogo', 'Attività', 'Orario', 'Ore Totali', 'Note'];

            const data = allUserRegistrations.map(reg => [
                formatDate(reg.date),
                reg.location || '-',
                reg.activity || '-',
                `${reg.startTime || '-'} - ${reg.endTime || '-'}`,
                reg.totalHours || '-',
                reg.notes || ''
            ]);

            // Crea il workbook
            const wb = XLSX.utils.book_new();
            const ws_data = [headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Stile per l'intestazione
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "0066FF" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Applica stile all'intestazione
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                ws[address].s = headerStyle;
            }

            // Imposta larghezza colonne
            ws['!cols'] = [
                { wch: 12 }, // Data
                { wch: 25 }, // Luogo
                { wch: 20 }, // Attività
                { wch: 20 }, // Orario
                { wch: 12 }, // Ore Totali
                { wch: 40 }  // Note
            ];

            // Aggiungi bordi e allineamento alle celle dati
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[address]) continue;
                    ws[address].s = {
                        border: {
                            top: { style: "thin", color: { rgb: "D1D5DB" } },
                            bottom: { style: "thin", color: { rgb: "D1D5DB" } },
                            left: { style: "thin", color: { rgb: "D1D5DB" } },
                            right: { style: "thin", color: { rgb: "D1D5DB" } }
                        },
                        alignment: { vertical: "center", wrapText: true }
                    };
                }
            }

            // Aggiungi il foglio al workbook
            XLSX.utils.book_append_sheet(wb, ws, "Ore di Lavoro");

            // Esporta
            XLSX.writeFile(wb, `timesheet-${currentUser.firstName.toLowerCase()}-${new Date().toISOString().split('T')[0]}.xlsx`);

            window.UI.showToast('Timesheet esportato', 'success');
        }
    </script>
</body>
</html>