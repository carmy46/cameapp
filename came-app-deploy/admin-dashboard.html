<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - CAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/effects.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="app-layout">
        <!-- Admin Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#0066FF;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#8B5CF6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00D9B1;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="24" cy="24" r="22" fill="url(#logoGradient)"/>
                        <path d="M18 16C21.866 16 25 19.134 25 23C25 26.866 21.866 30 18 30" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                        <path d="M29 30L33 16L37 30" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <path d="M31 26H35" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="logo-text">CAME</div>
            </div>

            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <a href="admin-dashboard.html" class="nav-item active">
                        <i data-lucide="bar-chart-3" class="nav-item-icon"></i>
                        <span class="sidebar-label">Panoramica</span>
                    </a>
                    <a href="admin-approvals.html" class="nav-item">
                        <i data-lucide="check-circle" class="nav-item-icon"></i>
                        <span class="sidebar-label">Approvazioni</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Gestione</div>
                    <a href="#" class="nav-item">
                        <i data-lucide="users" class="nav-item-icon"></i>
                        <span class="sidebar-label">Dipendenti</span>
                    </a>
                    <a href="admin-employee-hours.html" class="nav-item">
                        <i data-lucide="clock-3" class="nav-item-icon"></i>
                        <span class="sidebar-label">Ore Dipendenti</span>
                    </a>
                    <a href="admin-reports.html" class="nav-item">
                        <i data-lucide="file-text" class="nav-item-icon"></i>
                        <span class="sidebar-label">Report</span>
                    </a>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="nav-item w-full" onclick="safeLogout()" style="border: none; background: none; text-align: left;">
                    <i data-lucide="log-out" class="nav-item-icon"></i>
                    <span class="sidebar-label">Esci</span>
                </button>
            </div>

            <button class="sidebar-toggle" aria-label="Chiudi menu laterale">
                <i data-lucide="chevron-left"></i>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" data-sidebar-toggle aria-label="Apri menu laterale">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Dashboard Admin</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-outline btn-sm" onclick="safeLogout()" title="Esci dall'applicazione">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                    </button>

                    <div class="header-user" data-dropdown-toggle="userMenu">
                        <div class="avatar" id="userAvatar">
                            <span id="userInitials">--</span>
                        </div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Admin</div>
                            <div class="user-role">Amministratore</div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <!-- KPI Cards -->
                <div class="grid grid-cols-4 gap-6 mb-8 stagger-children">
                    <div class="card text-center hover-lift card-text-dark">
                        <i data-lucide="users" class="text-3xl text-primary-600 mb-3"></i>
                        <div class="text-2xl font-bold text-neutral-900 mb-1" id="totalEmployees">0</div>
                        <div class="text-sm text-neutral-600">Dipendenti Totali</div>
                    </div>

                    <div class="card text-center hover-lift card-text-dark">
                        <i data-lucide="clock-4" class="text-3xl text-warning-600 mb-3"></i>
                        <div class="text-2xl font-bold text-neutral-900 mb-1" id="pendingRequests">0</div>
                        <div class="text-sm text-neutral-600">Richieste Pendenti</div>
                        <span id="pendingBadge" class="badge badge-warning hidden">!</span>
                    </div>

                    <div class="card text-center hover-lift card-text-dark">
                        <i data-lucide="check-circle" class="text-3xl text-success-600 mb-3"></i>
                        <div class="text-2xl font-bold text-neutral-900 mb-1" id="approvedToday">0</div>
                        <div class="text-sm text-neutral-600">Approvate Oggi</div>
                    </div>

                    <div class="card text-center hover-lift card-text-dark">
                        <i data-lucide="activity" class="text-3xl text-secondary-600 mb-3"></i>
                        <div class="text-2xl font-bold text-neutral-900 mb-1" id="totalHours">0h</div>
                        <div class="text-sm text-neutral-600">Ore Totali Mese</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="card card-text-dark">
                        <div class="card-header">
                            <h3 class="card-title">Ore per Dipendente</h3>
                            <p class="card-subtitle">Ultimi 7 giorni</p>
                        </div>
                        <canvas id="hoursChart" height="200"></canvas>
                    </div>

                    <div class="card card-text-dark">
                        <div class="card-header">
                            <h3 class="card-title">Trend Richieste</h3>
                            <p class="card-subtitle">Ultimo mese</p>
                        </div>
                        <canvas id="requestsChart" height="200"></canvas>
                    </div>
                </div>

                <!-- Team Status & Quick Actions -->
                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 card card-text-dark">
                        <div class="card-header">
                            <h3 class="card-title">Stato del Team</h3>
                            <p class="card-subtitle">Situazione in tempo reale</p>
                        </div>
                        <div id="teamStatus" class="grid grid-cols-3 gap-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <div class="card card-text-dark">
                        <div class="card-header">
                            <h3 class="card-title">Richieste Recenti</h3>
                            <a href="admin-approvals.html" class="text-primary-600 text-sm">Vedi tutte â†’</a>
                        </div>
                        <div id="recentRequests" class="space-y-3">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/data.js"></script>

    <script>
        // Wait for all modules to load, then check authentication
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ”„ DOM loaded, checking modules...');

            // Check if critical modules are loaded
            const checkModules = () => {
                const modules = {
                    Auth: typeof window.Auth !== 'undefined',
                    UI: typeof window.UI !== 'undefined',
                    Data: typeof window.Data !== 'undefined',
                    Storage: typeof window.Storage !== 'undefined'
                };

                console.log('ðŸ“¦ Modules status:', modules);

                if (!modules.Auth || !window.Auth.getCurrentUser) {
                    console.error('âŒ Auth module not loaded properly');
                    alert('Errore di caricamento moduli. Redirecting to login...');
                    window.location.replace('index.html');
                    return false;
                }

                const currentUser = window.Auth.getCurrentUser();
                console.log('ðŸ‘¤ Current user:', currentUser);

                if (!currentUser || currentUser.role !== 'admin') {
                    console.log('â›” Access denied: Admin role required');
                    localStorage.removeItem('came_session');
                    window.location.replace('index.html');
                    return false;
                }

                // If we get here, user is authenticated admin
                console.log('âœ… Admin access granted for:', currentUser.firstName, currentUser.lastName);
                return true;
            };

            // Try immediately, then with delay if needed
            if (checkModules()) {
                initializeAdminDashboard();
            } else {
                setTimeout(() => {
                    if (checkModules()) {
                        initializeAdminDashboard();
                    }
                }, 500);
            }
        });

        function initializeAdminDashboard() {
            lucide.createIcons();
            loadAdminData();
            loadCharts();
            initializeUserInfo();
        }

        // This DOMContentLoaded is now handled in the authentication check above

        function initializeUserInfo() {
            document.getElementById('userName').textContent = window.Auth.getUserFullName();
            document.getElementById('userInitials').textContent = window.Auth.getUserInitials();
        }

        // Safe logout function that checks if Auth is available
        function safeLogout() {
            if (typeof window.Auth !== 'undefined' && window.Auth.logout) {
                window.Auth.logout();
            } else {
                console.log('Auth not available, performing manual logout');
                localStorage.removeItem('came_session');
                localStorage.removeItem('came_timesheet_data');
                localStorage.removeItem('came_requests_data');
                window.location.href = 'index.html';
            }
        }

        async function loadAdminData() {
            const stats = await window.Data.getAdminStats();
            if (!stats) return;

            console.log('ðŸ“Š Admin Stats loaded:', stats);

            // Update KPI cards
            document.getElementById('totalEmployees').textContent = stats.totalEmployees;
            document.getElementById('pendingRequests').textContent = stats.pendingRequestsCount;
            document.getElementById('approvedToday').textContent = stats.approvedToday;
            document.getElementById('totalHours').textContent = stats.totalHoursThisMonth + 'h';

            // Log dettagli per debug
            console.log('- Total Employees:', stats.totalEmployees);
            console.log('- Pending Requests:', stats.pendingRequestsCount);
            console.log('- Approved Today:', stats.approvedToday);
            console.log('- Total Hours This Month:', stats.totalHoursThisMonth);

            // Show badge for pending requests
            if (stats.pendingRequestsCount > 0) {
                document.getElementById('pendingBadge').classList.remove('hidden');
            } else {
                document.getElementById('pendingBadge').classList.add('hidden');
            }

            // Load team status
            loadTeamStatus(stats.teamStatus);

            // Load recent requests
            loadRecentRequests(stats.pendingRequests);
        }

        function loadTeamStatus(teamStatus) {
            const container = document.getElementById('teamStatus');

            container.innerHTML = teamStatus.map(member => `
                <div class="p-4 bg-neutral-50 rounded-lg hover-lift transition-fast">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="avatar avatar-sm">
                            <span>${member.avatar}</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-sm">${member.name}</div>
                        <div class="text-xs text-neutral-500">${window.UI.formatDate(member.lastSeen, 'hh:MM')}</div>
                        </div>
                    </div>
                    <span class="badge badge-${member.status.color} badge-sm">
                        ${member.status.label}
                    </span>
                </div>
            `).join('');
        }

        function loadRecentRequests(recentRequests) {
            const container = document.getElementById('recentRequests');

            if (recentRequests.length === 0) {
                container.innerHTML = '<p class="text-sm text-neutral-600 text-center py-4">Nessuna richiesta pendente</p>';
                return;
            }

            container.innerHTML = recentRequests.map(request => `
                <div class="flex items-start gap-3 p-3 bg-neutral-50 rounded-lg hover-lift transition-fast">
                    <div class="avatar avatar-sm">
                        <span>${request.user.avatar}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-sm mb-1">${request.user.firstName} ${request.user.lastName}</div>
                        <div class="text-xs text-neutral-600 mb-1">${window.Data.formatRequestType(request.type)}</div>
                        <div class="text-xs text-neutral-500">${window.UI.formatDate(request.startDate)}</div>
                    </div>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-success" onclick="quickApprove(${request.id})" title="Approva">
                            <i data-lucide="check" style="width: 12px; height: 12px;"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="quickReject(${request.id})" title="Rifiuta">
                            <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function loadCharts() {
            const chartData = window.Data.getChartData();
            if (!chartData) return;

            // Hours per employee chart
            const hoursCtx = document.getElementById('hoursChart').getContext('2d');
            new Chart(hoursCtx, {
                type: 'bar',
                data: chartData.hoursPerEmployee,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 10 }
                        }
                    }
                }
            });

            // Requests trend chart
            const requestsCtx = document.getElementById('requestsChart').getContext('2d');
            new Chart(requestsCtx, {
                type: 'line',
                data: chartData.requestTrends,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function quickApprove(requestId) {
            // Find the request across all users
            const allRequests = await window.Storage.getAllRequests();
            const targetRequest = allRequests.find(r => r.id == requestId);

            if (targetRequest && targetRequest.user) {
                await window.Storage.updateRequest(targetRequest.user.id, requestId, {
                    status: 'approved',
                    processedAt: new Date().toISOString(),
                    processedBy: window.Auth.getUserFullName()
                });

                window.UI.showToast('Richiesta approvata', 'success');
                await loadAdminData();
            }
        }

        async function quickReject(requestId) {
            // Find the request across all users
            const allRequests = await window.Storage.getAllRequests();
            const targetRequest = allRequests.find(r => r.id == requestId);

            if (targetRequest && targetRequest.user) {
                await window.Storage.updateRequest(targetRequest.user.id, requestId, {
                    status: 'rejected',
                    processedAt: new Date().toISOString(),
                    processedBy: window.Auth.getUserFullName()
                });

                window.UI.showToast('Richiesta rifiutata', 'info');
                await loadAdminData();
            }
        }

        // Auto refresh data every 30 seconds
        setInterval(loadAdminData, 30000);
    </script>
</body>
</html>