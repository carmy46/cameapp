<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Richieste - CAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- XLSX Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/effects.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#0066FF;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#8B5CF6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00D9B1;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="24" cy="24" r="22" fill="url(#logoGradient)"/>
                        <path d="M18 16C21.866 16 25 19.134 25 23C25 26.866 21.866 30 18 30" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                        <path d="M29 30L33 16L37 30" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <path d="M31 26H35" stroke="white" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="logo-text">CAME</div>
            </div>

            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principale</div>
                    <a href="employee-dashboard.html" class="nav-item">
                        <i data-lucide="home" class="nav-item-icon"></i>
                        <span class="sidebar-label">Dashboard</span>
                    </a>
                    <a href="timesheet.html" class="nav-item">
                        <i data-lucide="clock" class="nav-item-icon"></i>
                        <span class="sidebar-label">Ore di Lavoro</span>
                    </a>
                    <a href="time-registration.html" class="nav-item">
                        <i data-lucide="plus-circle" class="nav-item-icon"></i>
                        <span class="sidebar-label">Registrazione Ore</span>
                    </a>
                    <a href="requests.html" class="nav-item active">
                        <i data-lucide="calendar-check" class="nav-item-icon"></i>
                        <span class="sidebar-label">Richieste</span>
                    </a>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="nav-item w-full" onclick="window.Auth.logout()" style="border: none; background: none; text-align: left;">
                    <i data-lucide="log-out" class="nav-item-icon"></i>
                    <span class="sidebar-label">Esci</span>
                </button>
            </div>

            <button class="sidebar-toggle" aria-label="Chiudi menu laterale">
                <i data-lucide="chevron-left"></i>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" data-sidebar-toggle aria-label="Apri menu laterale">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="header-title">Richieste</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-outline btn-sm" onclick="exportToExcel()">
                        <i data-lucide="download"></i>
                        Esporta Excel
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="window.Auth.logout()" title="Esci dall'applicazione">
                        <i data-lucide="log-out"></i>
                        <span>Logout</span>
                    </button>

                    <button class="btn btn-primary" onclick="showNewRequestModal()">
                        <i data-lucide="plus"></i>
                        Nuova Richiesta
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Request Types Grid -->
                <div class="grid grid-cols-5 gap-4 mb-8">
                    <div class="card text-center hover-lift cursor-pointer card-text-dark" onclick="createQuickRequest('vacation')">
                        <i data-lucide="sun" class="text-3xl text-primary-600 mb-3 mx-auto"></i>
                        <h3 class="font-semibold mb-2">Ferie</h3>
                        <p class="text-sm text-neutral-600">Richiedi giorni di vacanza</p>
                    </div>
                    <div class="card text-center hover-lift cursor-pointer card-text-dark" onclick="createQuickRequest('sick_leave')">
                        <i data-lucide="heart-pulse" class="text-3xl text-error-600 mb-3 mx-auto"></i>
                        <h3 class="font-semibold mb-2">Malattia</h3>
                        <p class="text-sm text-neutral-600">Segnala assenza per malattia</p>
                    </div>
                    <div class="card text-center hover-lift cursor-pointer card-text-dark" onclick="createQuickRequest('personal')">
                        <i data-lucide="user" class="text-3xl text-secondary-600 mb-3 mx-auto"></i>
                        <h3 class="font-semibold mb-2">Permesso</h3>
                        <p class="text-sm text-neutral-600">Richiedi permesso personale</p>
                    </div>
                    <div class="card text-center hover-lift cursor-pointer card-text-dark" onclick="createQuickRequest('early_exit')">
                        <i data-lucide="clock-4" class="text-3xl text-warning-600 mb-3 mx-auto"></i>
                        <h3 class="font-semibold mb-2">Uscita Anticipata</h3>
                        <p class="text-sm text-neutral-600">Richiedi uscita prima</p>
                    </div>
                    <div class="card text-center hover-lift cursor-pointer card-text-dark" onclick="createQuickRequest('late_entry')">
                        <i data-lucide="clock-9" class="text-3xl text-accent-600 mb-3 mx-auto"></i>
                        <h3 class="font-semibold mb-2">Entrata Posticipata</h3>
                        <p class="text-sm text-neutral-600">Richiedi entrata ritardata</p>
                    </div>
                </div>

                <!-- Requests List -->
                <div class="card card-text-dark">
                    <div class="card-header">
                        <h3 class="card-title">Le Tue Richieste</h3>
                        <div class="flex gap-3">
                            <select id="statusFilter" class="btn btn-outline" onchange="filterRequests()">
                                <option value="">Tutti gli stati</option>
                                <option value="pending">In attesa</option>
                                <option value="approved">Approvate</option>
                                <option value="rejected">Rifiutate</option>
                            </select>
                            <input type="text" id="searchInput" placeholder="Cerca..." class="form-control" onkeyup="filterRequests()">
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Data</th>
                                    <th>Motivo</th>
                                    <th>Stato</th>
                                    <th>Inviata</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- New Request Modal -->
    <div id="newRequestModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nuova Richiesta</h3>
                <button class="modal-close" onclick="window.UI.hideModal('newRequestModal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <div class="input-group">
                        <select id="requestType" name="type" required>
                            <option value="">Seleziona tipo</option>
                            <option value="vacation">Ferie</option>
                            <option value="sick_leave">Malattia</option>
                            <option value="personal">Permesso Personale</option>
                            <option value="early_exit">Uscita Anticipata</option>
                            <option value="late_entry">Entrata Posticipata</option>
                        </select>
                        <label>Tipo di Richiesta</label>
                    </div>

                    <div class="input-group">
                        <input type="date" id="startDate" name="startDate" required>
                        <label>Data Inizio</label>
                    </div>

                    <div id="endDateGroup" class="input-group hidden">
                        <input type="date" id="endDate" name="endDate">
                        <label>Data Fine</label>
                    </div>

                    <div id="timeGroup" class="input-group hidden">
                        <input type="time" id="requestTime" name="time">
                        <label id="timeLabel">Ora</label>
                    </div>

                    <div class="input-group">
                        <textarea id="reason" name="reason" rows="3" required></textarea>
                        <label>Motivo</label>
                    </div>

                    <div class="input-group">
                        <textarea id="notes" name="notes" rows="2"></textarea>
                        <label>Note aggiuntive (opzionale)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="window.UI.hideModal('newRequestModal')">Annulla</button>
                <button class="btn btn-primary" onclick="submitRequest()">Invia Richiesta</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/data.js"></script>

    <script>
        // Check authentication without causing redirect loops
        const currentUser = window.Auth.getCurrentUser();
        if (!currentUser || currentUser.role !== 'employee') {
            console.log('Access denied: Employee role required for requests');
            localStorage.removeItem('came_session');
            window.location.replace('index.html');
        }

        let allRequests = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadRequests();
            setupFormHandlers();
        });

        async function loadRequests() {
            // Mostra skeleton loading
            window.UI.showTableSkeleton('#requestsTable', 5, 6);

            allRequests = await window.Storage.getRequestsData(currentUser.id);
            displayRequests(allRequests);
        }

        function displayRequests(requests) {
            const tbody = document.getElementById('requestsTable');

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-neutral-600">Nessuna richiesta trovata</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(request => `
                <tr>
                    <td>
                        <div class="flex items-center gap-2">
                            <i data-lucide="${getRequestIcon(request.type)}" class="text-neutral-600"></i>
                            <span>${window.Data.formatRequestType(request.type)}</span>
                        </div>
                    </td>
                    <td>${window.UI.formatDate(request.startDate)}${request.endDate ? ' - ' + window.UI.formatDate(request.endDate) : ''}</td>
                    <td class="max-w-xs truncate">${request.reason}</td>
                    <td><span class="badge ${window.Data.getStatusBadgeClass(request.status)}">${window.Data.formatRequestStatus(request.status)}</span></td>
                    <td>${window.UI.formatDate(request.submittedAt, 'dd/mm/yyyy hh:MM')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline mr-2" onclick="viewRequest(${request.id})">
                            <i data-lucide="eye"></i>
                        </button>
                        ${request.status === 'pending' ? `<button class="btn btn-sm btn-danger" onclick="deleteRequest(${request.id})"><i data-lucide="trash-2"></i></button>` : ''}
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function filterRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allRequests;

            if (statusFilter) {
                filtered = filtered.filter(r => r.status === statusFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(r =>
                    r.reason.toLowerCase().includes(searchTerm) ||
                    window.Data.formatRequestType(r.type).toLowerCase().includes(searchTerm)
                );
            }

            displayRequests(filtered);
        }

        function showNewRequestModal() {
            document.getElementById('requestForm').reset();
            document.getElementById('startDate').min = new Date().toISOString().split('T')[0];
            window.UI.showModal('newRequestModal');
        }

        function createQuickRequest(type) {
            showNewRequestModal();
            document.getElementById('requestType').value = type;
            updateRequestForm();
        }

        function setupFormHandlers() {
            document.getElementById('requestType').addEventListener('change', updateRequestForm);
        }

        function updateRequestForm() {
            const type = document.getElementById('requestType').value;
            const endDateGroup = document.getElementById('endDateGroup');
            const timeGroup = document.getElementById('timeGroup');
            const timeLabel = document.getElementById('timeLabel');

            // Hide all conditional fields
            endDateGroup.classList.add('hidden');
            timeGroup.classList.add('hidden');

            // Show fields based on type
            if (type === 'vacation' || type === 'sick_leave') {
                endDateGroup.classList.remove('hidden');
            }

            if (type === 'early_exit') {
                timeGroup.classList.remove('hidden');
                timeLabel.textContent = 'Ora uscita';
            } else if (type === 'late_entry') {
                timeGroup.classList.remove('hidden');
                timeLabel.textContent = 'Ora entrata';
            }
        }

        async function submitRequest() {
            const form = document.getElementById('requestForm');
            const formData = new FormData(form);

            const requestData = {
                type: formData.get('type'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate') || null,
                time: formData.get('time') || null,
                reason: formData.get('reason'),
                notes: formData.get('notes') || null
            };

            const validation = window.Data.validateRequest(requestData);
            if (!validation.isValid) {
                Object.keys(validation.errors).forEach(field => {
                    window.UI.showToast(validation.errors[field], 'error');
                });
                return;
            }

            const newRequest = await window.Storage.addRequest(currentUser.id, requestData);
            window.UI.showToast('Richiesta inviata con successo', 'success');
            window.UI.hideModal('newRequestModal');
            await loadRequests();
        }

        function viewRequest(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;

            let details = `
                <div class="space-y-3">
                    <div><strong>Tipo:</strong> ${Data.formatRequestType(request.type)}</div>
                    <div><strong>Data:</strong> ${UI.formatDate(request.startDate)}${request.endDate ? ' - ' + UI.formatDate(request.endDate) : ''}</div>
                    ${request.time ? `<div><strong>Ora:</strong> ${request.time}</div>` : ''}
                    <div><strong>Motivo:</strong> ${request.reason}</div>
                    ${request.notes ? `<div><strong>Note:</strong> ${request.notes}</div>` : ''}
                    <div><strong>Stato:</strong> <span class="badge ${Data.getStatusBadgeClass(request.status)}">${Data.formatRequestStatus(request.status)}</span></div>
                    <div><strong>Inviata:</strong> ${UI.formatDate(request.submittedAt, 'dd/mm/yyyy hh:MM')}</div>
                    ${request.processedAt ? `<div><strong>Processata:</strong> ${UI.formatDate(request.processedAt, 'dd/mm/yyyy hh:MM')}</div>` : ''}
                </div>
            `;

            window.UI.createModal('Dettagli Richiesta', details, [
                { text: 'Chiudi', class: 'btn-outline', onclick: 'window.UI.hideModal(arguments[0])' }
            ]);
        }

        async function deleteRequest(requestId) {
            window.UI.confirm('Sei sicuro di voler eliminare questa richiesta?', 'Elimina Richiesta').then(async (confirmed) => {
                if (confirmed) {
                    await window.Storage.deleteRequest(currentUser.id, requestId);
                    window.UI.showToast('Richiesta eliminata', 'success');
                    await loadRequests();
                }
            });
        }

        function getRequestIcon(type) {
            const icons = {
                vacation: 'sun',
                sick_leave: 'heart-pulse',
                personal: 'user',
                early_exit: 'clock-4',
                late_entry: 'clock-9'
            };
            return icons[type] || 'calendar';
        }

        function exportToExcel() {
            // Funzione helper per formattare la data
            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Prepara i dati per Excel
            const headers = ['Tipo', 'Data Inizio', 'Data Fine', 'Motivo', 'Note', 'Stato', 'Inviata'];

            const data = allRequests.map(req => [
                window.Data.formatRequestType(req.type),
                formatDate(req.startDate),
                req.endDate ? formatDate(req.endDate) : '-',
                req.reason || '',
                req.notes || '',
                window.Data.formatRequestStatus(req.status),
                formatDate(req.submittedAt)
            ]);

            // Crea il workbook
            const wb = XLSX.utils.book_new();
            const ws_data = [headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Stile per l'intestazione
            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "0066FF" } },
                alignment: { horizontal: "center", vertical: "center" }
            };

            // Applica stile all'intestazione
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                ws[address].s = headerStyle;
            }

            // Imposta larghezza colonne
            ws['!cols'] = [
                { wch: 18 }, // Tipo
                { wch: 12 }, // Data Inizio
                { wch: 12 }, // Data Fine
                { wch: 40 }, // Motivo
                { wch: 40 }, // Note
                { wch: 12 }, // Stato
                { wch: 12 }  // Inviata
            ];

            // Aggiungi bordi e allineamento alle celle dati
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[address]) continue;
                    ws[address].s = {
                        border: {
                            top: { style: "thin", color: { rgb: "D1D5DB" } },
                            bottom: { style: "thin", color: { rgb: "D1D5DB" } },
                            left: { style: "thin", color: { rgb: "D1D5DB" } },
                            right: { style: "thin", color: { rgb: "D1D5DB" } }
                        },
                        alignment: { vertical: "center", wrapText: true }
                    };
                }
            }

            // Aggiungi il foglio al workbook
            XLSX.utils.book_append_sheet(wb, ws, "Le Mie Richieste");

            // Esporta
            XLSX.writeFile(wb, `le-mie-richieste-${new Date().toISOString().split('T')[0]}.xlsx`);

            window.UI.showToast('Richieste esportate', 'success');
        }
    </script>
</body>
</html>